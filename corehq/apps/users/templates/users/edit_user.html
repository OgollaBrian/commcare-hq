{% extends "settings/base_template.html" %}
{% load i18n %}
{% load hq_shared_tags %}
{% load hqstyle_tags %}

{% block js %}{{ block.super }}
    <script src="{% static 'hqwebapp/js/lib/jquery.textchange.min.js' %}"></script>
    <script src="{% static 'users/js/key_filters.js' %}"></script>
    <script src="{% static 'hqwebapp/js/ui-element.js' %}"></script>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script type="text/javascript">
        $(function () {
            $('#id_add_phone_number').keydown(allowNumeric);
            var slide = false;
            $('#id_can_view_reports').change(function () {
                var show = slide ? 'slideDown' : 'show';
                var hide = slide ? 'slideUp' : 'hide';
                if ($(this).val() == 'some') {
                    $('#id_viewable_reports').parent().parent()[show]();
                } else {
                    $('#id_viewable_reports').parent().parent()[hide]();
                }
                slide = true;
            }).trigger('change');
            $('#id_role').change(function () {
                if ($(this).val() == 'admin') {
                    $('#id_can_view_reports').val('yes').attr({disabled: true}).trigger('change');
                } else {
                    $('#id_can_view_reports').attr({disabled: false});
                }
            }).trigger('change');
        });
    </script>
{% endblock %}

{% block main_column %}
    <form class="form form-horizontal" name="user_details" method="post">
        <input type="hidden" name="form_type" value="basic-info" />
        {% bootstrap_form_errors form %}
        <fieldset>
            <legend>User Information</legend>
            <div class="control-group">
                <label class="control-label">Username:</label>
                <div class="controls">
                    <span class="input-xlarge uneditable-input">{{ couch_user.html_username|safe }}</span>
                </div>
            </div>
            {% for field in form.visible_fields %}
                <div class="control-group{% if field.errors %} error{% endif %}">
                    <label class="control-label" for="{{ field.id }}">{{ field.label }}</label>
                    <div class="controls">
                        {{ field }}
                        {% for error in field.errors %}
                            <span class="help-inline">{{ error }}</span>
                        {% endfor %}
                        {% if field.help_text %}
                            <p class="help-block">
                                <i class="icon icon-info-sign"></i> {{ field.help_text }}
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </fieldset>
        <div class="form-actions"><button type="submit" class="btn btn-primary">Update Information</button></div>
    </form>

    <div class="form form-horizontal">
        <fieldset>
            {% for phone in phone_numbers_extended %}
                {% if forloop.first %}<legend>Registered Phone Numbers</legend>{% endif %}
                <div class="control-group">
                    <label class="control-label">+{{ phone.number }}
                        {% ifequal phone.status "verified" %}
                            <div><span class="label label-success"><small>VERIFIED</small></span></div>
                        {% endifequal %}
                        {% ifequal phone.status "pending" %}
                            <div><span class="label"><small>VERIFICATION PENDING</small></span></div>
                        {% endifequal %}
                        {% ifequal phone.status "duplicate" %}
                            <div>{% if phone.dup_url %}<a href="{{ phone.dup_url }}">{% endif %}<span class="label label-warning"><small>ALREADY IN USE</small></span>{% if phone.dup_url %}</a>{% endif %}</div>
                        {% endifequal %}
                        {% ifequal phone.status "invalid" %}
                            <div><span class="label"><small>INVALID FORMAT</small></span></div>
                        {% endifequal %}
                    </label>

                    <div class="controls">
                        {% ifnotequal couch_user.doc_type "WebUser" %}

                            {% ifequal phone.status "unverified" %}
                                <form method="post" action="{% url verify_phone_number domain couch_user.couch_id %}?phone_number={{phone.number|urlencode}}" style="display: inline;">
                                    <button type="submit" title="Send a verification SMS to this phone. When the user replies to this SMS, the phone number will be verified." class="btn btn-primary"><i class="icon icon-signal icon-white"></i> Verify</button>
                                </form>
                            {% endifequal %}

                            {% ifequal phone.status "duplicate" %}
                                <a title="You cannot verify this phone because it is already being used elsewhere" class="btn btn-primary disabled"><i class="icon icon-signal icon-white"></i> Verify</a>
                            {% endifequal %}

                            {% ifequal phone.status "pending" %}
                                <a title="Re-send the verification SMS to this phone" class="btn btn-primary" data-toggle="modal" href="#reverify_{{phone.number|urlencode}}"><i class="icon icon-signal icon-white"></i> Verify (retry)</a>
                            {% endifequal %}

                        {% endifnotequal %}

                        <a class="btn btn-danger" data-toggle="modal" href="#delete_phonenumber_{{ forloop.counter }}"><i class="icon icon-remove icon-white"></i> Delete</a>
                    </div>
                </div>
            {% endfor %}
        </fieldset>
    </div>
    <form class="form form-horizontal" name="add_phone_number" method="post">
        <input type="hidden" name="form_type" value="phone-numbers" />
        <fieldset>
            <legend>Add a New Number</legend>
            <div class="control-group">
                <label class="control-label" for="id_add_phone_number">Phone Number:</label>
                <div class="controls">
                    <div class="input-prepend">
                        <span class="add-on">+</span>
                        <input id="id_add_phone_number" type="text" name="phone_number" value="" maxlength="50" />
                    </div>
                    <p class="help-block">
                        Please enter number, including international code, in digits only.
                    </p>
                </div>
            </div>
        </fieldset>
        <div class="form-actions"><button type="submit" class="btn btn-primary">Add Number</button></div>
    </form>
{% endblock %}

{% block modals %}{{ block.super }}
    {% for phone_number in couch_user.phone_numbers %}
        <div id="delete_phonenumber_{{ forloop.counter }}" class="modal hide fade">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">&times;</a>
                <h3>Delete +{{ phone_number }}?</h3>
            </div>
            <form class="form form-horizontal hq-form" name="delete_phone_number" action="{% url delete_phone_number domain couch_user.couch_id %}?phone_number={{phone_number|urlencode}}" method="post">
                <div class="modal-body">
                    <p>Are you sure you want to delete the phone number: "+{{ phone_number }}"?</p>
                </div>
                <div class="modal-footer">
                    <a href="#" data-dismiss="modal" class="btn">Cancel</a>
                    <button type="submit" class="btn btn-danger"><i class="icon icon-remove icon-white"></i> Delete</button>
                </div>
            </form>
        </div>
    {% endfor %}
    {% for phone in phone_numbers_extended %}
        {% ifequal phone.status "pending" %}
            <div id="reverify_{{phone.number|urlencode}}" class="modal hide fade">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">&times;</a>
                    <h3>Verify +{{ phone.number }}?</h3>
                </div>
                <form class="form form-horizontal hq-form" name="reverify_phone_number" action="{% url verify_phone_number domain couch_user.couch_id %}?phone_number={{phone.number|urlencode}}" method="post">
                    <div class="modal-body">
                        <p>A verification message has already been sent to this phone. The phone has not replied yet. Send again?</p>
                    </div>
                    <div class="modal-footer">
                        <a href="#" data-dismiss="modal" class="btn">Cancel</a>
                        <button type="submit" class="btn btn-primary"><i class="icon icon-signal icon-white"></i> Verify</button>
                    </div>
                </form>
            </div>
        {% endifequal %}
    {% endfor %}
{% endblock %}

